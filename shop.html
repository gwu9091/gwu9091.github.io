<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>商店｜毛孩到府服務平台</title>

  <!-- CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/style.css">

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script src="./js/navbar-loader.js"></script>
</head>
<style>
  .myposition{
    bottom:15%;
    left:90%
  }
</style>

<body class="position-relative">
  <!-- Navbar -->
  <div id="navbar-placeholder"></div>

  <div class="container mymargin-1">
    <h1 class="text-center mb-4">毛孩商品商店</h1>
    <div id="product-list" class="row g-3"></div>
  </div>
  <button class="position-absolute myposition">
    <a href="./cart.html">結帳</a>
  </button>

  <!-- Footer -->
  <footer class="fixed-bottom">
    <p>© 2025 毛孩到府服務平台 | 保留所有權利</p>
  </footer>

  <script>
    // 確認 Supabase 已初始化
    document.addEventListener("navbarLoaded", async () => {
      if (!window.supabaseClient) return console.error("Supabase 尚未初始化");

      const supabase = window.supabaseClient;
      const productList = document.getElementById("product-list");

      // 載入商品資料
      async function loadProducts() {
        const { data, error } = await supabase
          .from("products")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) {
          productList.innerHTML = `<p class="text-danger">無法讀取商品資料：${error.message}</p>`;
          return;
        }

        productList.innerHTML = data.map(p => `
          <div class="col-md-3">
            <div class="card h-100">
              <img src="${p.image_url}" class="card-img-top" alt="${p.name}">
              <div class="card-body">
                <h5 class="card-title">${p.name}</h5>
                <p class="card-text">${p.description}</p>
                <p class="card-text"><strong>$${p.price}</strong></p>
                <button class="btn btn-primary add-to-cart" 
                  data-id="${p.id}" data-name="${p.name}" data-price="${p.price}">
                  加入購物車
                </button>
              </div>
            </div>
          </div>
        `).join("");

        // 綁定加入購物車按鈕
        document.querySelectorAll(".add-to-cart").forEach(btn => {
          btn.addEventListener("click", async () => {
            const { data: sessionData } = await supabase.auth.getSession();
            const user = sessionData.session?.user;
            if (!user) return alert("請先登入會員");

            const product = {
              id: btn.dataset.id,
              name: btn.dataset.name,
              price: parseFloat(btn.dataset.price),
              quantity: 1
            };

            // 讀取會員購物車
            let { data: cart } = await supabase
              .from("carts")
              .select("*")
              .eq("user_id", user.id)
              .single();

            if (!cart) {
              // 新增購物車
              await supabase.from("carts").insert([{ user_id: user.id, items: [product] }]);
            } else {
              // 更新購物車
              const index = cart.items.findIndex(i => i.id == product.id);
              if (index > -1) {
                cart.items[index].quantity += 1;
              } else {
                cart.items.push(product);
              }
              await supabase
                .from("carts")
                .update({ items: cart.items, updated_at: new Date().toISOString() })
                .eq("user_id", user.id);
            }

            alert(`${product.name} 已加入購物車`);
          });
        });
      }

      loadProducts();
    });
  </script>
</body>

</html>