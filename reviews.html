<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>服務者評價系統 | 毛孩到府服務平台</title>
  <link rel="stylesheet" href="./css/style.css">
  <link rel="stylesheet" href="./css/reviews.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- 動態載入 navbar 並初始化 supabaseClient -->
  <script src="./js/navbar-loader.js"></script>
</head>

<body>
  <!-- 與主頁、加入我們相同的 navbar 占位符 -->

  <div id="navbar-placeholder"></div>
  <div class="container mt-5">
    <h1>服務者評價系統</h1>
    <label for="provider">選擇服務者：</label>
    <select id="provider" name="provider">
      <option value="小雪美容師">小雪美容師</option>
      <option value="麗娜美容師">麗娜美容師</option>
      <option value="小華老師">小華老師</option>
      <option value="阿傑照護師">阿傑照護師</option>
      <option value="阿明">阿明</option>
    </select>

    <label for="rating">星數：</label>
    <select id="rating" name="rating">
      <option value="5">⭐⭐⭐⭐⭐</option>
      <option value="4">⭐⭐⭐⭐</option>
      <option value="3">⭐⭐⭐</option>
      <option value="2">⭐⭐</option>
      <option value="1">⭐</option>
    </select>

    <textarea id="comment" placeholder="撰寫評價..." rows="4"></textarea>
    <button id="submit-btn">送出評價</button>

    <hr>
    <h2>已提交評價</h2>
    <div id="reviews"></div>
  </div>
  <footer>
    <p>
      © 2025 毛孩到府服務平台 | 保留所有權利
    </p>
  </footer>
 <script>
  const providerSelect = document.getElementById("provider");
  const reviewsDiv = document.getElementById("reviews");
  const submitBtn = document.getElementById("submit-btn");
  const commentInput = document.getElementById("comment");

  // 等待 navbar 載入完成且 supabaseClient 初始化後，才開始執行資料讀取
  document.addEventListener("navbarLoaded", () => {
    if (!window.supabaseClient) {
      console.error("supabaseClient 尚未初始化");
      return;
    }
    loadReviews();
  });

  // 切換服務者時重新載入
  providerSelect.addEventListener("change", () => {
    if (window.supabaseClient) loadReviews();
  });

  // 送出評價
  submitBtn.addEventListener("click", async () => {
    if (!window.supabaseClient) {
      alert("系統尚未準備好，請稍後再試");
      return;
    }

    const {
      data: { session },
    } = await window.supabaseClient.auth.getSession();

    if (!session) {
      alert("⚠️ 請先登入後才能送出評價！");
      return;
    }

    const provider = providerSelect.value;
    const rating = parseInt(document.getElementById("rating").value);
    const comment = commentInput.value.trim();

    if (comment === "") {
      alert("請輸入評價內容");
      return;
    }

    const { error } = await window.supabaseClient
      .from("reviews")
      .insert([{ provider_name: provider, rating, comment }]);

    if (!error) {
      alert("✅ 評價送出成功");
      commentInput.value = "";
      loadReviews();
    } else {
      alert("❌ 無法送出：" + error.message);
    }
  });

  // 載入評價
  async function loadReviews() {
    const provider = providerSelect.value;
    const { data, error } = await window.supabaseClient
      .from("reviews")
      .select("*")
      .eq("provider_name", provider)
      .order("created_at", { ascending: false });

    if (error) {
      reviewsDiv.innerHTML = "⚠️ 無法讀取資料：" + error.message;
      return;
    }

    const count = data.length;
    const avg = count
      ? data.reduce((acc, r) => acc + r.rating, 0) / count
      : 0;

    reviewsDiv.innerHTML =
  `<h3 class="text-start">平均星數：${avg.toFixed(1)} / 5 （共 ${count} 筆評價）</h3>` +   // ⭐ 這裡 text-center → text-start
  data
    .map(
      (r) => `
      <div class="card my-2 text-start"> 
        <div class="card-body">
          <strong>${"⭐".repeat(r.rating)}</strong>
          <p class="mb-1">${r.comment}</p>
          <small class="text-muted">${new Date(r.created_at).toLocaleString()}</small>
        </div>
      </div>`
    )
    .join("");

  }
</script>

</body>

</html>